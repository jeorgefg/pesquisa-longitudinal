<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Área Administrativa - Pesquisa Longitudinal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">Pesquisa Longitudinal</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Início</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="sobre.html">Sobre a Pesquisa</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="formulario_inicial.html">Formulário Inicial</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="formulario_intermediario.html">Formulário Intermediário</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="formulario_final.html">Formulário Final</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="admin.html">Área Administrativa</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="container my-4">
        <div class="row hero-section">
            <div class="col-md-12 text-center">
                <h1 class="display-5 fw-bold">Área Administrativa</h1>
                <p class="lead">Gerenciamento da Pesquisa Longitudinal</p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container my-4">
        <div class="row">
            <div class="col-md-12">
                <!-- Login Form (mostrado inicialmente) -->
                <div id="login-section" class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title mb-0">Login Administrativo</h3>
                    </div>
                    <div class="card-body">
                        <form id="login-form">
                            <div class="mb-3">
                                <label for="username" class="form-label">Usuário</label>
                                <input type="text" class="form-control" id="username" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Senha</label>
                                <input type="password" class="form-control" id="password" required>
                            </div>
                            <div class="alert alert-danger d-none" id="login-error">
                                Usuário ou senha incorretos. Por favor, tente novamente.
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">Entrar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Dashboard (escondido até login) -->
                <div id="dashboard-section" class="d-none">
                    <div class="alert alert-success mb-4">
                        <h4 class="alert-heading">Bem-vindo à Área Administrativa!</h4>
                        <p>Aqui você pode gerenciar os dados da pesquisa longitudinal, visualizar estatísticas e exportar os resultados.</p>
                    </div>

                    <!-- Tabs de navegação -->
                    <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="resumo-tab" data-bs-toggle="tab" data-bs-target="#resumo" type="button" role="tab">Resumo</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="inicial-tab" data-bs-toggle="tab" data-bs-target="#inicial" type="button" role="tab">Formulários Iniciais</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="final-tab" data-bs-toggle="tab" data-bs-target="#final" type="button" role="tab">Formulários Finais</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="comparativo-tab" data-bs-toggle="tab" data-bs-target="#comparativo" type="button" role="tab">Análise Comparativa</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="exportar-tab" data-bs-toggle="tab" data-bs-target="#exportar" type="button" role="tab">Exportar Dados</button>
                        </li>
                    </ul>

                    <!-- Conteúdo das tabs -->
                    <div class="tab-content" id="adminTabsContent">
                        <!-- Tab Resumo -->
                        <div class="tab-pane fade show active" id="resumo" role="tabpanel">
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h4 class="card-title mb-0">Estatísticas da Pesquisa</h4>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 col-lg-3 mb-4">
                                            <div class="card bg-primary text-white">
                                                <div class="card-body text-center">
                                                    <h5 class="card-title">Formulários Iniciais</h5>
                                                    <h2 id="count-inicial">0</h2>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 col-lg-3 mb-4">
                                            <div class="card bg-success text-white">
                                                <div class="card-body text-center">
                                                    <h5 class="card-title">Formulários Finais</h5>
                                                    <h2 id="count-final">0</h2>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 col-lg-3 mb-4">
                                            <div class="card bg-info text-white">
                                                <div class="card-body text-center">
                                                    <h5 class="card-title">Pareamentos</h5>
                                                    <h2 id="count-pareados">0</h2>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 col-lg-3 mb-4">
                                            <div class="card bg-warning text-dark">
                                                <div class="card-body text-center">
                                                    <h5 class="card-title">Taxa de Conclusão</h5>
                                                    <h2 id="taxa-conclusao">0%</h2>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mt-4">
                                        <div class="col-md-6 mb-4">
                                            <div class="card h-100">
                                                <div class="card-header bg-light">
                                                    <h5 class="card-title mb-0">Áreas de Interesse Inicial</h5>
                                                </div>
                                                <div class="card-body">
                                                    <canvas id="chart-areas-inicial"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-4">
                                            <div class="card h-100">
                                                <div class="card-header bg-light">
                                                    <h5 class="card-title mb-0">Áreas de Interesse Final</h5>
                                                </div>
                                                <div class="card-body">
                                                    <canvas id="chart-areas-final"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-12 mb-4">
                                            <div class="card">
                                                <div class="card-header bg-light">
                                                    <h5 class="card-title mb-0">Média dos Traços de Personalidade</h5>
                                                </div>
                                                <div class="card-body">
                                                    <canvas id="chart-tipi-comparativo"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab Formulários Iniciais -->
                        <div class="tab-pane fade" id="inicial" role="tabpanel">
                            <div class="card mb-4">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h4 class="card-title mb-0">Formulários Iniciais</h4>
                                    <button class="btn btn-sm btn-primary" id="btn-export-inicial">Exportar CSV</button>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Código</th>
                                                    <th>Idade</th>
                                                    <th>Gênero</th>
                                                    <th>Área de Interesse</th>
                                                    <th>Data de Envio</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody id="table-inicial">
                                                <tr>
                                                    <td colspan="6" class="text-center">Carregando dados...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab Formulários Finais -->
                        <div class="tab-pane fade" id="final" role="tabpanel">
                            <div class="card mb-4">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h4 class="card-title mb-0">Formulários Finais</h4>
                                    <button class="btn btn-sm btn-primary" id="btn-export-final">Exportar CSV</button>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Código</th>
                                                    <th>Área de Interesse Atual</th>
                                                    <th>Expectativas Atendidas</th>
                                                    <th>Data de Envio</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody id="table-final">
                                                <tr>
                                                    <td colspan="5" class="text-center">Carregando dados...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab Análise Comparativa -->
                        <div class="tab-pane fade" id="comparativo" role="tabpanel">
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h4 class="card-title mb-0">Análise Comparativa</h4>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        <p>Esta seção mostra a análise comparativa dos alunos que preencheram tanto o formulário inicial quanto o final.</p>
                                    </div>
                                    
                                    <div class="row mt-4">
                                        <div class="col-md-6 mb-4">
                                            <div class="card h-100">
                                                <div class="card-header bg-light">
                                                    <h5 class="card-title mb-0">Mudança nas Áreas de Interesse</h5>
                                                </div>
                                                <div class="card-body">
                                                    <canvas id="chart-mudanca-areas"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-4">
                                            <div class="card h-100">
                                                <div class="card-header bg-light">
                                                    <h5 class="card-title mb-0">Expectativas Atendidas</h5>
                                                </div>
                                                <div class="card-body">
                                                    <canvas id="chart-expectativas"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-12 mb-4">
                                            <div class="card">
                                                <div class="card-header bg-light">
                                                    <h5 class="card-title mb-0">Evolução dos Traços de Personalidade</h5>
                                                </div>
                                                <div class="card-body">
                                                    <canvas id="chart-evolucao-tipi"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive mt-4">
                                        <h5>Alunos com Formulários Pareados</h5>
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Código</th>
                                                    <th>Área Inicial</th>
                                                    <th>Área Final</th>
                                                    <th>Expectativas Atendidas</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody id="table-pareados">
                                                <tr>
                                                    <td colspan="5" class="text-center">Carregando dados...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab Exportar Dados -->
                        <div class="tab-pane fade" id="exportar" role="tabpanel">
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h4 class="card-title mb-0">Exportar Dados</h4>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4 mb-4">
                                            <div class="card">
                                                <div class="card-body text-center">
                                                    <h5 class="card-title">Formulários Iniciais</h5>
                                                    <p class="card-text">Exportar todos os dados dos formulários iniciais em formato CSV.</p>
                                                    <button class="btn btn-primary" id="btn-export-inicial-full">Exportar CSV</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-4">
                                            <div class="card">
                                                <div class="card-body text-center">
                                                    <h5 class="card-title">Formulários Finais</h5>
                                                    <p class="card-text">Exportar todos os dados dos formulários finais em formato CSV.</p>
                                                    <button class="btn btn-primary" id="btn-export-final-full">Exportar CSV</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-4">
                                            <div class="card">
                                                <div class="card-body text-center">
                                                    <h5 class="card-title">Dados Pareados</h5>
                                                    <p class="card-text">Exportar dados pareados (inicial + final) em formato CSV.</p>
                                                    <button class="btn btn-primary" id="btn-export-pareados">Exportar CSV</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-info mt-4">
                                        <h5 class="alert-heading">Instruções para Análise dos Dados</h5>
                                        <p>Os arquivos CSV exportados podem ser abertos no Excel ou em outros programas de planilha para análise detalhada.</p>
                                        <hr>
                                        <p class="mb-0">Para análises estatísticas mais avançadas, recomendamos o uso de softwares como SPSS, R ou Python com bibliotecas como pandas e scipy.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>Pesquisa Longitudinal - Curso de Psicologia</h5>
                    <p>Faculdade Anhanguera de Feira de Santana</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <h5>Contato</h5>
                    <p>Em caso de dúvidas, entre em contato com a coordenação do curso</p>
                    <p>Email: coordenacao.psicologia@anhanguera.com</p>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-md-12 text-center">
                    <p>&copy; 2025 Faculdade Anhanguera de Feira de Santana. Todos os direitos reservados.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/scripts.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se já está logado
            const isLoggedIn = sessionStorage.getItem('admin-logged-in') === 'true';
            if (isLoggedIn) {
                showDashboard();
                loadDashboardData();
            }
            
            // Processar formulário de login
            document.getElementById('login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                fetch('/api/admin/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        sessionStorage.setItem('admin-logged-in', 'true');
                        sessionStorage.setItem('admin-token', data.token);
                        showDashboard();
                        loadDashboardData();
                    } else {
                        document.getElementById('login-error').classList.remove('d-none');
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    
                    // Para fins de demonstração, permitir login com credenciais fixas
                    if (username === 'admin' && password === 'admin123') {
                        sessionStorage.setItem('admin-logged-in', 'true');
                        sessionStorage.setItem('admin-token', 'demo-token');
                        showDashboard();
                        loadDashboardData();
                    } else {
                        document.getElementById('login-error').classList.remove('d-none');
                    }
                });
            });
            
            // Botões de exportação
            document.getElementById('btn-export-inicial').addEventListener('click', function() {
                exportFormData('inicial');
            });
            
            document.getElementById('btn-export-final').addEventListener('click', function() {
                exportFormData('final');
            });
            
            document.getElementById('btn-export-inicial-full').addEventListener('click', function() {
                exportFormData('inicial');
            });
            
            document.getElementById('btn-export-final-full').addEventListener('click', function() {
                exportFormData('final');
            });
            
            document.getElementById('btn-export-pareados').addEventListener('click', function() {
                exportPairedData();
            });
        });
        
        function showDashboard() {
            document.getElementById('login-section').classList.add('d-none');
            document.getElementById('dashboard-section').classList.remove('d-none');
        }
        
        function loadDashboardData() {
            // Carregar dados dos formulários
            Promise.all([
                fetch('/api/formularios/inicial').then(res => res.json()).catch(() => ({ success: false })),
                fetch('/api/formularios/final').then(res => res.json()).catch(() => ({ success: false }))
            ])
            .then(([dataInicial, dataFinal]) => {
                const formulariosIniciais = dataInicial.success ? dataInicial.formularios : getMockFormulariosIniciais();
                const formulariosFinais = dataFinal.success ? dataFinal.formularios : getMockFormulariosFinais();
                
                updateDashboardStats(formulariosIniciais, formulariosFinais);
                populateFormulariosIniciais(formulariosIniciais);
                populateFormulariosFinais(formulariosFinais);
                populateFormulariosPareados(formulariosIniciais, formulariosFinais);
                createCharts(formulariosIniciais, formulariosFinais);
            })
            .catch(error => {
                console.error('Erro ao carregar dados:', error);
                
                // Usar dados simulados em caso de erro
                const formulariosIniciais = getMockFormulariosIniciais();
                const formulariosFinais = getMockFormulariosFinais();
                
                updateDashboardStats(formulariosIniciais, formulariosFinais);
                populateFormulariosIniciais(formulariosIniciais);
                populateFormulariosFinais(formulariosFinais);
                populateFormulariosPareados(formulariosIniciais, formulariosFinais);
                createCharts(formulariosIniciais, formulariosFinais);
            });
        }
        
        function updateDashboardStats(formulariosIniciais, formulariosFinais) {
            // Contar formulários
            document.getElementById('count-inicial').textContent = formulariosIniciais.length;
            document.getElementById('count-final').textContent = formulariosFinais.length;
            
            // Contar pareamentos
            const codigosIniciais = formulariosIniciais.map(f => f.codigo);
            const codigosFinais = formulariosFinais.map(f => f.codigo);
            const pareados = codigosIniciais.filter(codigo => codigosFinais.includes(codigo));
            document.getElementById('count-pareados').textContent = pareados.length;
            
            // Calcular taxa de conclusão
            const taxaConclusao = formulariosIniciais.length > 0 
                ? Math.round((pareados.length / formulariosIniciais.length) * 100) 
                : 0;
            document.getElementById('taxa-conclusao').textContent = `${taxaConclusao}%`;
        }
        
        function populateFormulariosIniciais(formularios) {
            const tableBody = document.getElementById('table-inicial');
            
            if (formularios.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum formulário encontrado</td></tr>';
                return;
            }
            
            tableBody.innerHTML = '';
            formularios.forEach(form => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${form.codigo}</td>
                    <td>${form.idade}</td>
                    <td>${form.genero}</td>
                    <td>${form.area_interesse}</td>
                    <td>${form.data_envio || 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewFormDetail('${form.codigo}', 'inicial')">Ver</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function populateFormulariosFinais(formularios) {
            const tableBody = document.getElementById('table-final');
            
            if (formularios.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum formulário encontrado</td></tr>';
                return;
            }
            
            tableBody.innerHTML = '';
            formularios.forEach(form => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${form.codigo}</td>
                    <td>${form.area_interesse_atual}</td>
                    <td>${form.expectativas_atendidas}</td>
                    <td>${form.data_envio || 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewFormDetail('${form.codigo}', 'final')">Ver</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function populateFormulariosPareados(formulariosIniciais, formulariosFinais) {
            const tableBody = document.getElementById('table-pareados');
            
            // Encontrar códigos que existem em ambos os conjuntos
            const codigosIniciais = formulariosIniciais.map(f => f.codigo);
            const pareados = formulariosFinais.filter(f => codigosIniciais.includes(f.codigo));
            
            if (pareados.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum formulário pareado encontrado</td></tr>';
                return;
            }
            
            tableBody.innerHTML = '';
            pareados.forEach(formFinal => {
                const formInicial = formulariosIniciais.find(f => f.codigo === formFinal.codigo);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formFinal.codigo}</td>
                    <td>${formInicial.area_interesse}</td>
                    <td>${formFinal.area_interesse_atual}</td>
                    <td>${formFinal.expectativas_atendidas}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewComparison('${formFinal.codigo}')">Comparar</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function createCharts(formulariosIniciais, formulariosFinais) {
            // Áreas de interesse inicial
            createAreaInteresseChart('chart-areas-inicial', formulariosIniciais, 'area_interesse');
            
            // Áreas de interesse final
            createAreaInteresseChart('chart-areas-final', formulariosFinais, 'area_interesse_atual');
            
            // Média dos traços de personalidade
            createTIPIComparativoChart('chart-tipi-comparativo', formulariosIniciais, formulariosFinais);
            
            // Mudança nas áreas de interesse
            createMudancaAreasChart('chart-mudanca-areas', formulariosIniciais, formulariosFinais);
            
            // Expectativas atendidas
            createExpectativasChart('chart-expectativas', formulariosFinais);
            
            // Evolução dos traços de personalidade
            createEvolucaoTIPIChart('chart-evolucao-tipi', formulariosIniciais, formulariosFinais);
        }
        
        function createAreaInteresseChart(canvasId, formularios, fieldName) {
            // Contar ocorrências de cada área de interesse
            const areas = {};
            formularios.forEach(form => {
                const area = form[fieldName];
                if (area) {
                    areas[area] = (areas[area] || 0) + 1;
                }
            });
            
            // Preparar dados para o gráfico
            const labels = Object.keys(areas);
            const data = Object.values(areas);
            
            // Criar gráfico
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                            'rgba(199, 199, 199, 0.7)',
                            'rgba(83, 102, 255, 0.7)',
                            'rgba(40, 159, 64, 0.7)',
                            'rgba(210, 199, 199, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }
        
        function createTIPIComparativoChart(canvasId, formulariosIniciais, formulariosFinais) {
            // Calcular médias dos traços
            const traitsInicial = calculateAverageTraits(formulariosIniciais);
            const traitsFinal = calculateAverageTraits(formulariosFinais);
            
            // Criar gráfico
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [
                        'Extroversão',
                        'Amabilidade',
                        'Conscienciosidade',
                        'Estabilidade Emocional',
                        'Abertura a Experiências'
                    ],
                    datasets: [
                        {
                            label: 'Formulários Iniciais',
                            data: [
                                traitsInicial.extroversao,
                                traitsInicial.amabilidade,
                                traitsInicial.conscienciosidade,
                                traitsInicial.estabilidade_emocional,
                                traitsInicial.abertura
                            ],
                            backgroundColor: 'rgba(54, 162, 235, 0.7)'
                        },
                        {
                            label: 'Formulários Finais',
                            data: [
                                traitsFinal.extroversao,
                                traitsFinal.amabilidade,
                                traitsFinal.conscienciosidade,
                                traitsFinal.estabilidade_emocional,
                                traitsFinal.abertura
                            ],
                            backgroundColor: 'rgba(255, 99, 132, 0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 7
                        }
                    }
                }
            });
        }
        
        function createMudancaAreasChart(canvasId, formulariosIniciais, formulariosFinais) {
            // Encontrar formulários pareados
            const pareados = [];
            formulariosIniciais.forEach(formInicial => {
                const formFinal = formulariosFinais.find(f => f.codigo === formInicial.codigo);
                if (formFinal) {
                    pareados.push({
                        inicial: formInicial.area_interesse,
                        final: formFinal.area_interesse_atual
                    });
                }
            });
            
            // Contar mudanças
            let semMudanca = 0;
            let comMudanca = 0;
            
            pareados.forEach(par => {
                if (par.inicial === par.final) {
                    semMudanca++;
                } else {
                    comMudanca++;
                }
            });
            
            // Criar gráfico
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Manteve a mesma área', 'Mudou de área'],
                    datasets: [{
                        data: [semMudanca, comMudanca],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 159, 64, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }
        
        function createExpectativasChart(canvasId, formulariosFinais) {
            // Contar ocorrências de cada resposta
            const expectativas = {
                'Totalmente atendidas': 0,
                'Parcialmente atendidas': 0,
                'Não atendidas': 0
            };
            
            formulariosFinais.forEach(form => {
                const resposta = form.expectativas_atendidas;
                if (resposta) {
                    expectativas[resposta] = (expectativas[resposta] || 0) + 1;
                }
            });
            
            // Criar gráfico
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(expectativas),
                    datasets: [{
                        data: Object.values(expectativas),
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(255, 99, 132, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }
        
        function createEvolucaoTIPIChart(canvasId, formulariosIniciais, formulariosFinais) {
            // Encontrar formulários pareados
            const pareados = [];
            formulariosIniciais.forEach(formInicial => {
                const formFinal = formulariosFinais.find(f => f.codigo === formInicial.codigo);
                if (formFinal) {
                    pareados.push({
                        inicial: {
                            extroversao: formInicial.extroversao,
                            amabilidade: formInicial.amabilidade,
                            conscienciosidade: formInicial.conscienciosidade,
                            estabilidade_emocional: formInicial.estabilidade_emocional,
                            abertura: formInicial.abertura
                        },
                        final: {
                            extroversao: formFinal.extroversao,
                            amabilidade: formFinal.amabilidade,
                            conscienciosidade: formFinal.conscienciosidade,
                            estabilidade_emocional: formFinal.estabilidade_emocional,
                            abertura: formFinal.abertura
                        }
                    });
                }
            });
            
            // Calcular médias
            const mediaInicial = calculateAverageTraitsFromPaired(pareados, 'inicial');
            const mediaFinal = calculateAverageTraitsFromPaired(pareados, 'final');
            
            // Criar gráfico
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: [
                        'Extroversão',
                        'Amabilidade',
                        'Conscienciosidade',
                        'Estabilidade Emocional',
                        'Abertura a Experiências'
                    ],
                    datasets: [
                        {
                            label: 'Início do Curso',
                            data: [
                                mediaInicial.extroversao,
                                mediaInicial.amabilidade,
                                mediaInicial.conscienciosidade,
                                mediaInicial.estabilidade_emocional,
                                mediaInicial.abertura
                            ],
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                            pointBorderColor: '#fff'
                        },
                        {
                            label: 'Final do Curso',
                            data: [
                                mediaFinal.extroversao,
                                mediaFinal.amabilidade,
                                mediaFinal.conscienciosidade,
                                mediaFinal.estabilidade_emocional,
                                mediaFinal.abertura
                            ],
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            pointBackgroundColor: 'rgba(255, 99, 132, 1)',
                            pointBorderColor: '#fff'
                        }
                    ]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: {
                                display: true
                            },
                            suggestedMin: 1,
                            suggestedMax: 7
                        }
                    }
                }
            });
        }
        
        function calculateAverageTraits(formularios) {
            if (formularios.length === 0) {
                return {
                    extroversao: 0,
                    amabilidade: 0,
                    conscienciosidade: 0,
                    estabilidade_emocional: 0,
                    abertura: 0
                };
            }
            
            const sum = {
                extroversao: 0,
                amabilidade: 0,
                conscienciosidade: 0,
                estabilidade_emocional: 0,
                abertura: 0
            };
            
            formularios.forEach(form => {
                sum.extroversao += parseFloat(form.extroversao || 0);
                sum.amabilidade += parseFloat(form.amabilidade || 0);
                sum.conscienciosidade += parseFloat(form.conscienciosidade || 0);
                sum.estabilidade_emocional += parseFloat(form.estabilidade_emocional || 0);
                sum.abertura += parseFloat(form.abertura || 0);
            });
            
            return {
                extroversao: sum.extroversao / formularios.length,
                amabilidade: sum.amabilidade / formularios.length,
                conscienciosidade: sum.conscienciosidade / formularios.length,
                estabilidade_emocional: sum.estabilidade_emocional / formularios.length,
                abertura: sum.abertura / formularios.length
            };
        }
        
        function calculateAverageTraitsFromPaired(pareados, type) {
            if (pareados.length === 0) {
                return {
                    extroversao: 0,
                    amabilidade: 0,
                    conscienciosidade: 0,
                    estabilidade_emocional: 0,
                    abertura: 0
                };
            }
            
            const sum = {
                extroversao: 0,
                amabilidade: 0,
                conscienciosidade: 0,
                estabilidade_emocional: 0,
                abertura: 0
            };
            
            pareados.forEach(par => {
                sum.extroversao += parseFloat(par[type].extroversao || 0);
                sum.amabilidade += parseFloat(par[type].amabilidade || 0);
                sum.conscienciosidade += parseFloat(par[type].conscienciosidade || 0);
                sum.estabilidade_emocional += parseFloat(par[type].estabilidade_emocional || 0);
                sum.abertura += parseFloat(par[type].abertura || 0);
            });
            
            return {
                extroversao: sum.extroversao / pareados.length,
                amabilidade: sum.amabilidade / pareados.length,
                conscienciosidade: sum.conscienciosidade / pareados.length,
                estabilidade_emocional: sum.estabilidade_emocional / pareados.length,
                abertura: sum.abertura / pareados.length
            };
        }
        
        function exportFormData(formType) {
            const csvContent = exportToCSV(formType);
            if (csvContent) {
                downloadFile(csvContent, `formularios_${formType}_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv');
            }
        }
        
        function exportPairedData() {
            // Esta função seria implementada para exportar dados pareados
            alert('Funcionalidade em desenvolvimento. Por favor, exporte os formulários iniciais e finais separadamente por enquanto.');
        }
        
        function viewFormDetail(codigo, tipo) {
            window.open(`resultados_tipi.html?codigo=${codigo}&tipo=${tipo}`, '_blank');
        }
        
        function viewComparison(codigo) {
            window.open(`resultados_comparativos.html?codigo=${codigo}`, '_blank');
        }
        
        // Funções para gerar dados simulados para demonstração
        function getMockFormulariosIniciais() {
            return [
                {
                    codigo: 'ABC123',
                    idade: 18,
                    genero: 'Feminino',
                    situacao_trabalho: 'Não trabalha',
                    area_interesse: 'Psicologia Clínica',
                    proposito: 'Ajudar pessoas a superarem traumas e dificuldades emocionais.',
                    expectativa_curso: 'Aprender técnicas terapêuticas e compreender melhor o comportamento humano.',
                    expectativa_carreira: 'Abrir um consultório e trabalhar com terapia individual.',
                    desafios: 'Conciliar estudos com vida pessoal.',
                    extroversao: 4.0,
                    amabilidade: 5.5,
                    conscienciosidade: 5.0,
                    estabilidade_emocional: 4.0,
                    abertura: 5.5,
                    data_envio: '2025-01-15'
                },
                {
                    codigo: 'DEF456',
                    idade: 19,
                    genero: 'Masculino',
                    situacao_trabalho: 'Trabalha meio período',
                    area_interesse: 'Psicologia Organizacional',
                    proposito: 'Melhorar o ambiente de trabalho nas empresas.',
                    expectativa_curso: 'Aprender sobre comportamento humano em grupos e organizações.',
                    expectativa_carreira: 'Trabalhar em RH de grandes empresas.',
                    desafios: 'Conciliar trabalho e estudos.',
                    extroversao: 5.5,
                    amabilidade: 4.5,
                    conscienciosidade: 6.0,
                    estabilidade_emocional: 5.0,
                    abertura: 4.5,
                    data_envio: '2025-01-20'
                },
                {
                    codigo: 'GHI789',
                    idade: 25,
                    genero: 'Feminino',
                    situacao_trabalho: 'Trabalha período integral',
                    area_interesse: 'Neuropsicologia',
                    proposito: 'Compreender a relação entre cérebro e comportamento.',
                    expectativa_curso: 'Aprender sobre avaliação neuropsicológica e reabilitação cognitiva.',
                    expectativa_carreira: 'Trabalhar em hospitais com pacientes neurológicos.',
                    desafios: 'Administrar o tempo entre trabalho e estudos.',
                    extroversao: 3.5,
                    amabilidade: 5.0,
                    conscienciosidade: 6.5,
                    estabilidade_emocional: 4.5,
                    abertura: 6.0,
                    data_envio: '2025-01-25'
                }
            ];
        }
        
        function getMockFormulariosFinais() {
            return [
                {
                    codigo: 'ABC123',
                    area_interesse_atual: 'Neuropsicologia',
                    proposito_atual: 'Trabalhar com reabilitação cognitiva e avaliação neuropsicológica.',
                    expectativas_atendidas: 'Parcialmente atendidas',
                    justificativa_expectativas: 'O curso ofereceu boa base teórica, mas senti falta de mais prática clínica.',
                    desafios_enfrentados: 'Carga horária intensa e estágios exigentes.',
                    superacao_desafios: 'Organizei melhor meu tempo e busquei supervisão extra.',
                    mudanca_interesse: 'Descobri a neuropsicologia durante uma disciplina no 6º semestre e me apaixonei pela área.',
                    mudanca_proposito: 'Meu foco mudou da clínica geral para a especialização em neuropsicologia.',
                    planos_pos_formatura: 'Fazer pós-graduação',
                    detalhamento_planos: 'Fazer especialização em neuropsicologia, trabalhar em hospital e eventualmente abrir consultório.',
                    extroversao: 4.5,
                    amabilidade: 6.0,
                    conscienciosidade: 6.5,
                    estabilidade_emocional: 5.0,
                    abertura: 6.0,
                    data_envio: '2025-05-10'
                },
                {
                    codigo: 'DEF456',
                    area_interesse_atual: 'Psicologia Organizacional',
                    proposito_atual: 'Desenvolver programas de qualidade de vida no trabalho.',
                    expectativas_atendidas: 'Totalmente atendidas',
                    justificativa_expectativas: 'O curso ofereceu excelente base teórica e prática na área organizacional.',
                    desafios_enfrentados: 'Conciliar trabalho e estudos, especialmente durante os estágios.',
                    superacao_desafios: 'Negociei horário flexível no trabalho e organizei melhor minha agenda.',
                    mudanca_interesse: 'Mantive o interesse pela área organizacional, mas com foco mais específico em qualidade de vida.',
                    mudanca_proposito: 'Meu propósito se tornou mais específico e alinhado com minhas experiências práticas.',
                    planos_pos_formatura: 'Continuar na empresa atual',
                    detalhamento_planos: 'Buscar promoção para o setor de RH e iniciar MBA em Gestão de Pessoas.',
                    extroversao: 5.5,
                    amabilidade: 5.0,
                    conscienciosidade: 6.5,
                    estabilidade_emocional: 5.5,
                    abertura: 5.0,
                    data_envio: '2025-05-15'
                }
            ];
        }
    </script>
</body>
</html>
